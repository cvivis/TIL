# Spring Batch Architecture

스프링 배치는 확장성과 다양한 사용자 유형을 고려해 설계되었다.
아래는 최종 사용자인 **개발자를 위해 편의성과 확장성을 지원**하는 계층화된 아키텍처를 보여준다.

<p align="center">
  <img src="../../image/BatchArchitecture.png">
</p>

이 아키텍처는 세 가지 주요 구성 요소인 애플리케이션, 코어, 배치 인프라스트럭처를 강조한다.

- **애플리케이션**: 개발자가 Spring Batch를 사용하여 작성한 코드를 포함한다. 즉, 실제로 수행할 작업을 정의하는 곳.
- **배치 코어**: 배치 작업을 실행하고 제어하는 데 필요한 핵심 런타임 클래스(JobLauncher, Job, Step에 대한 구현)을 포함한다. 이 구성 요소는 배치 작업의 실행을 관리하는 역할을 한다.

→ **애플리케이션과 코어는 모두 인프라스트럭쳐 위에서 구축된다.**

- **배치 인프라스트럭처**: 애플리케이션 개발자가 사용하는 것뿐만 아니라 코어 프레임워크 자체에서도 사용되는 ItemReader와 ItemWriter, RetryTemplate과 같은 서비스가 포함되어 있다.

## **일반적인 배치 전략과 가이드라인 (General Batch Principles and Guidelines)**

> 배치 솔류션은 아래의 핵심 원칙, 가이드라인 , 그외의 사항들을 고려해 개발해야 한다.

- 배치 아키텍처는 보통 온라인 아키텍처에 영향을 주고 , 반대도 마찬가지 이다.
  가능하면 공통 구성 요소를 활용하고 아키텍처와 환경을 모두 고려해 설계해라
- 단일 배치 애플리케이션은 가능한 단순화 하고 복잡한 로직은 피해라
- 데이터를 처리하는 곳에 데이터를 저장해라
- 1️⃣ **시스템 리소스 특히 I/O를 최소화해라.** 내부 메모리에서 가능한 많은 연산을 실행해라.
- 불필요한 물리적 I/O를 줄이기 위해 SQL구문을 분석해라
  - 한 번 읽고 캐시나 작업 스토리지에 저장해도 되는 데이터를 매 트랜잭션 때 마다 읽는 경우
  - 같은 트랜잭션 내에서 이미 읽은 데이터를 다시 읽는 경우
  - 불필요한 테이블 스캔이나 인덱스 스캔을 유발하는 경우
  - SQL구문에서 Where절에 키를 지정하지 않는 경우
- **배치 실행에서 같은 작업을 두번하지 마라**
  - ex) 2️⃣ 보고 목적으로 데이터를 요약하는 애플리케이션이라면 데이터를 처음 처리할 때 이미 저장되어있는 값을 업데이트 하여 같은 데이터를 다시 처리하지 않게 해라
- 실행 중에 재할당에 시간을 쏟지 않게 배치 애플리케이션 시작시 충분한 메모리를 할당해라
- 데이터 무결성은 최악의 상황을 고려하여 적절한 유효성 검증 로직을 추가해라
- 3️⃣ 가능한 곳에 내부 검증을 위한 체크섬을 구현해라
  - 4️⃣ flat 파일은 파일의 총 레코드 수와 주요 필드의 집계 결과를 알 수 있는 트레일러 레코드가 필요하다.
- 실제 운영 환경과 그에 맞는 데이터 볼륨을 가지고 가능한 빨리 부하 테스트를 계획하고 실행해라.
- 무중단배포 서버진행시 배치 규모가 크면 백업이 어려울 수 있다. 하지만 데이터베이스 백업만큼 파일 백업도 중요하기 때문에 시스템이 flat파일을 사용한다면 파일 백업 절차를 수립하고 문서화하고 정기적으로 테스트해야한다.
  </br>
  </br>

---

</br>

**❓) 의문 정리**

1️⃣ : 예를 들어 여러 개의 데이터를 한 번에 읽어와 메모리에 저장 후 필요한 계산이나 변환 작업을 진행해 한 번만 결과를 DB에 저장하며 I/O를 줄일 수 있다.

- **병렬 처리** : 멀티 스레드를 사용하여 배치 작업을 동시에 실행함으로서 I/O작업을 분산시키고, 전체 처리 시간을 줄일 수 있다.
  - Chunk기반 처리 진행시 각 데이터 청크를 멀티 스레드로 처리하여 I/O 대기시간을 줄일 수 있다.
- **비동기 처리** : 비동기 I/O를 활용하여 데이터를 처리하는 동안 다른 작업을 동시에 수행할 수 있게 한다.
  - 데이터베이스에서 데이터를 읽는 동안 계산 작업(CPU사용) 진행시 I/O 대기 시간을 최소화 할 수 있다.
- **배치 크기 조정** : 배치 작업의 크기를 조정하여 각 I/O 호출에서 효율적으로 처리한는 데이터 양을 최적화한다.
  - 너무 작은 배치 사이즈는 잦은 I/O호출을 발생시키고 , 너무 큰 배치사이즈는 메모리 자원을 소모한다.
- **데이터 파이프라인 사용**
  - 아파치 Kafka와 같은 메시지 큐 시스템을 사용하여 데이터를 비동기적으로 처리하고, I/O작업을 분산시킨다. 이를 통해 각 컴포넌트가 독립적으로 작업을 수행할 수 있으며 시스템 자원이 효율적으로 사용된다.
- **Chunk기반 처리** : 데이터를 일정크기(Chunk)로 나누어 한번에 처리해 DB와의 통신을 최소화 할 수 있다.
- **읽기 캐싱** : 데이터를 메모리에 캐싱하여 반복적인 I/O작업을 피한다. ex)
  - ex) ItemReader에서 데이터를 읽은 후 메모리에 저장해 두고, 필요할 때마다 재사용하기.
- DB데이터를 가지고 오는 경우 **필요한 컬럼**만 선택해 불필요한 데이터의 I/O를 줄인다.
- **SQL쿼리를 최적화**하여 불필요한 테이블 스캔을 피한다.

2️⃣ : 쉽게 말하면 처음 계산할때 통계 데이터를 만들어 필요할때 그 값을 업데이트 하여 동일 데이터에 대한 재처리를 방지하자

3️⃣ : 체크섬 : 데이터 무결성 검증을 위해 데이터에서 계산 된값으로 이를 파일에 저장하여 파일이 손상되었는지 확인할 수 있다.

4️⃣ : flat 파일 → 보통 하나의 테이블을 플레인 텍스트 파일로 인코딩한 파일

- 각 데이터 레코드는 한 줄에 저장되어 쉼표,탭,공백과 같은 필드간의 구분자를 사용한다.
- ex) CSV
- 파일의 마지막에 추가되어 집계한 트레일러 레코드를 통해 파일의 손상을 확인할 수 있다.

</br>
</br>

# 관련 유용한 글

- **카카오 페이 I/O성능 개선**

[Spring Batch 애플리케이션 성능 향상을 위한 주요 팁 | 카카오페이 기술 블로그](https://tech.kakaopay.com/post/spring-batch-performance/#성능-개선-방법-정리)

- **카카오페이 Aggregation을 통한 성능 고려**

[[if kakao 2022] Batch Performance를 고려한 최선의 Aggregation | 카카오페이 기술 블로그](https://tech.kakaopay.com/post/ifkakao2022-batch-performance-aggregation/)

- 플랫 파일?

[플랫 파일 데이터베이스](https://ko.wikipedia.org/wiki/플랫_파일_데이터베이스)
